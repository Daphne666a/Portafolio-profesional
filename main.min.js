// Script de traducción y cambio de idioma
document.addEventListener("DOMContentLoaded", function () {
	// Botones de idioma
	const langButtons = document.querySelectorAll("[data-language-bottom]");

	// Idioma inicial (desde localStorage o por defecto "es")
	const initialLang = localStorage.getItem("preferred-lang") || "es";

	// Cargar idioma inicial
	loadLanguage(initialLang);

	// Asignar eventos a los botones de idioma
	langButtons.forEach(function (btn) {
		btn.addEventListener("click", function () {
			const selectedLang = btn.getAttribute("data-language-bottom");
			loadLanguage(selectedLang);
		});
	});
});

// Carga el archivo JSON del idioma y actualiza la UI
async function loadLanguage(lang) {
	try {
		const response = await fetch(`./${lang}.json`);

		if (!response.ok) {
			throw new Error(`No se pudo cargar ${lang}.json`);
		}

		const texts = await response.json();

		// Persistir idioma
		localStorage.setItem("preferred-lang", lang);

		// Actualizar atributo lang del HTML
		document.documentElement.lang = lang;

		// Traducir la interfaz
		translateUI(texts);
	} catch (error) {
		console.error("Error traducción:", error);
	}
}

// Obtiene un valor anidado usando un path tipo "seccion.subseccion.clave"
function getNestedValue(obj, path) {
	return path.split(".").reduce(function (current, key) {
		return current?.[key];
	}, obj);
}

// Recorre los elementos con data-value y aplica las traducciones
function translateUI(texts) {
	document.querySelectorAll("[data-value]").forEach(function (el) {
		const key = el.getAttribute("data-value");
		const section = el.getAttribute("data-section");

		// Caso simple para hero
		if (!section) {
			if (texts.hero?.[key]) {
				el.textContent = texts.hero[key];
			}
			return;
		}

		// Detectar si el elemento pertenece a cards con arrays
		const card = el.closest(".card,.project-card,.skill-card");
		if (card) {
			handleArrays(el, texts, key, section, card);
			return;
		}

		// Obtener objeto base
		const baseObject = texts[key];
		if (!baseObject) {
			return;
		}

		// Obtener traducción por path
		const translatedText = getNestedValue(baseObject, section);
		if (!translatedText) {
			return;
		}

		// Aplicar traducción según tipo de elemento
		if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
			el.placeholder = translatedText;
		} else if (el.tagName === "LABEL") {
			if (el.firstChild?.nodeType === 3) {
				el.firstChild.textContent = translatedText;
			} else {
				el.textContent = translatedText;
			}
		} else if (el.classList.contains("panel-text") || el.innerHTML.includes("<br")) {
			el.innerHTML = translatedText;
		} else {
			el.textContent = translatedText;
		}
	});
}

// Manejo de traducciones en listas/arrays dentro de cards
function handleArrays(el, texts, key, section, card) {
	const index = Array.from(card.parentElement.children).indexOf(card);
	const item = texts[key]?.items?.[index];

	if (!item) {
		return;
	}

	el.textContent = typeof item === "string" ? item : item[section];
}